#!/usr/bin/env bash

# socat with sslv2 && sslv3 support for proxies
# symlinks the built socat to /usr/local/bin/socat23
#
# 2017 - @leonjza
set -e

# https://en.wikipedia.org/wiki/OpenSSL
#   sslv2 is ripped from 1.1.0 so build latest 1.0.2
OPENSSL_VER=1.0.2m
SOCAT_VER=1.7.4.3
WORKING_DIR=/usr/local/src

# OpenSSL first
echo "Preparing working directory..."
mkdir -p $WORKING_DIR
cd $WORKING_DIR

echo "Downloading OpenSSL $OPENSSL_VER..."
curl -s -O https://www.openssl.org/source/openssl-$OPENSSL_VER.tar.gz

echo "Unpacking and building..."
tar xvf openssl-$OPENSSL_VER.tar.gz
cd openssl-$OPENSSL_VER

./config --prefix=`pwd`/local --openssldir=/usr/lib/ssl enable-ssl2 enable-ssl3-method enable-des enable-rc4 enable-weak-ssl-ciphers enable-ssl3 shared
make depend
make
make -i install

# set variables to use in socat build
OPENSSL_LIBS=`pwd`/local/lib
OPENSSL_INCLUDE=`pwd`/local/include
OPENSSL_RPATH="-Wl,-rpath,'\$\$ORIGIN/../openssl-$OPENSSL_VER/local/lib' -Wl,-z,origin"

echo "OpenSSL build complete."

# Next, socat!
cd $WORKING_DIR

echo "Downloading socat..."
curl -s -O http://www.dest-unreach.org/socat/download/socat-$SOCAT_VER.tar.gz

echo "Unpacking and building..."
tar xvf socat-$SOCAT_VER.tar.gz
cd socat-$SOCAT_VER

./configure LIBS="-L$OPENSSL_LIBS" CPPFLAGS="-I$OPENSSL_INCLUDE" LDFLAGS="$OPENSSL_RPATH"
make

echo "Creating symlink to new socat for 'socat-ssl23'..."
ln -s `pwd`/socat /usr/local/bin/socat-ssl23

echo "Done"