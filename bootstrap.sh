#!/usr/bin/env bash

if [ "$(id -u)" != "0" ]; then
    echo 'Must be run as root!' 1>&2
    exit 1
fi

QUIET=0
while getopts q opt; do
    case $opt in
        q) QUIET=1
        ;;
    esac
done

export DEBIAN_FRONTEND=noninteractive

OLD_PWD=$PWD
BASE_PATH=$(dirname $(realpath $0))

subsource() {
    echo -e "\n\e[93m░▒▓ $2 ▓▒░\e[0m\n"
    if [ $QUIET == 1 ]; then
        exec 3>&1
        exec 4>&2
        exec &>/dev/null
    fi
    . $BASE_PATH/$1
    if [ $QUIET == 1 ]; then
        exec 1>&3-
        exec 2>&4-
    fi
    if [ $? -eq 0 ]; then
        echo -e "\e[32mDone!\e[0m";
    else
        echo -e "\n\e[91;5m░▒▓ $2 failed! ▓▒░\e[0m\n"; exit;
    fi
    cd $OLD_PWD
}

DEFAULT_USERNAME=$(cat /etc/group | grep sudo | cut -d: -f4 | cut -d, -f1)
DEFAULT_SSHD_PORT=22

read -p "Your normal user account (additional tools will be installed in ~/lib): [$DEFAULT_USERNAME] " USERNAME
USERNAME=${USERNAME:-$DEFAULT_USERNAME}

read -p "SSH daemon port: [$DEFAULT_SSHD_PORT] " SSHD_PORT
SSHD_PORT=${SSHD_PORT:-$DEFAULT_SSHD_PORT}

subsource 'kali.locale.sh' 'Setting locale'
subsource 'kali.update.sh' 'Updating'
subsource 'kali.env.sh' 'Configuring environment'
subsource 'kali.base.sh' 'Installing base packages'

for fil in $(ls -1 $BASE_PATH/kali.extra.*.sh); do
    extra_package=`basename $fil | cut -d. -f 3`
    while true; do
        read -p "Install $extra_package? (y/n): " answer
        case $answer in
            [Yy]* ) subsource `basename $fil` "Installing $extra_package" $BASE_PATH; break;;
            [Nn]* ) break;;
            * ) echo "Answer yes or no.";;
        esac
    done
done

subsource 'kali.hardening.sh' 'Hardening'

while true; do
    read -p "Disable IPv6? (y/n): " answer
    case $answer in
        [Yy]* ) subsource 'kali.disable.ipv6.sh' 'Disabling IPv6'; break;;
        [Nn]* ) break;;
        * ) echo "Answer yes or no.";;
    esac
done

while true; do
    read -p 'Enable host name changing? (y/n): ' answer
    case $answer in
        [Yy]* ) subsource 'kali.enable.namechange.sh' 'Enabling host name change'; break;;
        [Nn]* ) break;;
        * ) echo "Answer yes or no.";;
    esac
done

echo -e "\e[32;1;5mFinished!\e[0m (reboot is recommended)"