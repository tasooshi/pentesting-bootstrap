#!/usr/bin/env bash

QUIET=0
ALL_YES=0

show_help() {
    echo -e "usage: bootstrap.sh [-h] [-q] [-y]\n\nFast and easy way of setting up a hardened pentesting environment with Kali Linux\n\nOptional arguments:\n\t-h\t\tShow this help message and exit\n\t-q\t\tRun quietly\n\t-y\t\tAnswer \"yes\" to all"
}

while getopts q,y,h opt; do
    case "$opt" in
        q) QUIET=1;;
        y) ALL_YES=1;;
        h) show_help;exit;
    esac
done

if [ "$(id -u)" != "0" ]; then
    echo 'Must be run as root! (`-h` for usage)' 1>&2
    exit 1
fi

export DEBIAN_FRONTEND=noninteractive

OLD_PWD=$PWD
BASE_PATH=$(dirname $(realpath $0))

subsource() {
    echo -e "\n\e[93m░▒▓ $2 ▓▒░\e[0m\n"
    if [ $QUIET == 1 ]; then
        exec 3>&1
        exec 4>&2
        exec &>/dev/null
    fi
    . $BASE_PATH/$1
    if [ $QUIET == 1 ]; then
        exec 1>&3-
        exec 2>&4-
    fi
    if [ $? -eq 0 ]; then
        echo -e "\e[32mDone!\e[0m";
    else
        echo -e "\n\e[91;5m░▒▓ $2 failed! ▓▒░\e[0m\n"; exit;
    fi
    cd $OLD_PWD
}

DEFAULT_USERNAME=$(cat /etc/group | grep sudo | cut -d: -f4 | cut -d, -f1)
DEFAULT_SSHD_PORT=22

read -p "Your normal user account (additional tools will be installed in ~/lib): [$DEFAULT_USERNAME] " BOOTSTRAP_USERNAME
export BOOTSTRAP_USERNAME=${BOOTSTRAP_USERNAME:-$DEFAULT_USERNAME}
export BOOTSTRAP_HOMEDIR=`getent passwd $BOOTSTRAP_USERNAME | cut -d: -f6`
export BOOTSTRAP_LIBDIR=$BOOTSTRAP_HOMEDIR/lib
echo "Home directory: $BOOTSTRAP_HOMEDIR"
echo "Packages directory: $BOOTSTRAP_LIBDIR"

read -p "SSH daemon port: [$DEFAULT_SSHD_PORT] " SSHD_PORT
SSHD_PORT=${SSHD_PORT:-$DEFAULT_SSHD_PORT}

subsource 'kali.locale.sh' 'Setting locale'
subsource 'kali.update.sh' 'Updating'
subsource 'kali.env.sh' 'Configuring environment'

for fil in $(ls -1 $BASE_PATH/kali.extra.*.sh); do
    extra_package=`basename $fil | cut -d. -f 3`
    while true; do
        if [ $ALL_YES == 1 ]; then
            answer=y
        else
            read -p "Run $extra_package? (y/n): " answer
        fi
        case $answer in
            [Yy]* ) subsource `basename $fil` "Running $extra_package" $BASE_PATH; break;;
            [Nn]* ) break;;
            * ) echo "Answer yes or no.";;
        esac
    done
done

echo -e "\e[32;1;5mFinished!\e[0m (reboot is recommended)"